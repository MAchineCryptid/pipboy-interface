import pygame
import sys
import psutil
import datetime
import subprocess

# Initialize Pygame
pygame.init()

# Screen settings
WIDTH, HEIGHT = 800, 480
screen = pygame.display.set_mode((WIDTH, HEIGHT))
pygame.display.set_caption("Raspberry Pi Pip-Boy")

# Colors
GREEN = (57, 255, 20)
BLACK = (0, 0, 0)
ACTIVE_TAB_COLOR = (30, 180, 10)
INACTIVE_TAB_COLOR = BLACK
TEXT_COLOR = GREEN
ACTIVE_TEXT_COLOR = BLACK  # Text color for active tab

# Fonts
font = pygame.font.Font(None, 36)
small_font = pygame.font.Font(None, 24)

# Screen types (tabs)
STATUS_SCREEN = 0
WIKI_SCREEN = 1
GPS_SCREEN = 2
RADIO_SCREEN = 3

# Start on the STATUS screen
current_screen = STATUS_SCREEN
previous_screen = STATUS_SCREEN

# Define the tabs
tabs = ["STATUS", "WIKI", "GPS", "RADIO"]

# Create a surface for screen content (fix for NameError)
screen_content = pygame.Surface((WIDTH, HEIGHT - 40))

# Function to get CPU usage
def get_cpu_usage():
    return f"CPU: {psutil.cpu_percent()}%"

# Function to get battery percentage (if available)
def get_battery_percentage():
    try:
        battery = psutil.sensors_battery()
        if battery:
            return f"Battery: {battery.percent}%"
        else:
            return "Battery: N/A"
    except AttributeError:
        return "Battery: N/A"

# Function to get Wi-Fi signal strength
def get_wifi_signal():
    try:
        result = subprocess.run(["iwconfig", "wlan0"], capture_output=True, text=True)
        if "Signal level=" in result.stdout:
            signal_level = result.stdout.split("Signal level=")[1].split(" ")[0]
            return f"Wi-Fi: {signal_level} dBm"
        else:
            return "Wi-Fi: No Signal"
    except:
        return "Wi-Fi: N/A"

# Function to get current date and time
def get_datetime():
    now = datetime.datetime.now()
    return now.strftime("%Y-%m-%d %H:%M:%S")

def draw_text(text, x, y, font_size=36, color=GREEN):
    font = pygame.font.Font(None, font_size)
    rendered_text = font.render(text, True, color)
    screen_content.blit(rendered_text, (x, y))

def draw_tabs():
    tab_width = WIDTH // len(tabs)
    for i, tab in enumerate(tabs):
        tab_rect = pygame.Rect(i * tab_width, 0, tab_width, 40)
        if i == current_screen:
            pygame.draw.rect(screen, ACTIVE_TAB_COLOR, tab_rect)
            text_color = ACTIVE_TEXT_COLOR
        else:
            pygame.draw.rect(screen, INACTIVE_TAB_COLOR, tab_rect)
            text_color = GREEN
        text_surface = small_font.render(tab, True, text_color)
        text_rect = text_surface.get_rect(center=(i * tab_width + tab_width // 2, 20))
        screen.blit(text_surface, text_rect)

def fade_in():
    for alpha in range(0, 255, 5):
        overlay = pygame.Surface((WIDTH, HEIGHT))
        overlay.fill((0, 0, 0))
        overlay.set_alpha(alpha)
        screen.blit(overlay, (0, 0))
        pygame.display.flip()
        pygame.time.delay(1)

def fade_out():
    for alpha in range(255, 0, -5):
        overlay = pygame.Surface((WIDTH, HEIGHT))
        overlay.fill((0, 0, 0))
        overlay.set_alpha(alpha)
        screen.blit(overlay, (0, 0))
        pygame.display.flip()
        pygame.time.delay(1)

def draw_status_screen():
    screen_content.fill(BLACK)
    draw_text("SYSTEM STATUS", 280, 60, font_size=48)
    draw_text(get_cpu_usage(), 50, 150, font_size=30)
    draw_text(get_battery_percentage(), 50, 200, font_size=30)
    draw_text(get_wifi_signal(), 50, 250, font_size=30)
    draw_text("Date & Time:", 50, 300, font_size=30)
    draw_text(get_datetime(), 50, 340, font_size=30)

def draw_gps_screen():
    screen_content.fill(BLACK)
    draw_text("GPS: Searching...", 50, 20, font_size=24)
    draw_text("Status: Not Locked", 50, 60, font_size=24)

def draw_wiki_screen():
    screen_content.fill(BLACK)
    draw_text("Offline Wiki: Ready", 50, 20, font_size=24)

def draw_radio_screen():
    screen_content.fill(BLACK)
    draw_text("Radio: Scanning...", 50, 20, font_size=24)

def main():
    global current_screen, previous_screen
    clock = pygame.time.Clock()
    screens = [STATUS_SCREEN, WIKI_SCREEN, GPS_SCREEN, RADIO_SCREEN]
    
    while True:
        if current_screen != previous_screen:
            fade_out()
            screen.fill(BLACK)
            previous_screen = current_screen
            fade_in()

        draw_tabs()

        if current_screen == STATUS_SCREEN:
            draw_status_screen()
        elif current_screen == WIKI_SCREEN:
            draw_wiki_screen()
        elif current_screen == GPS_SCREEN:
            draw_gps_screen()
        elif current_screen == RADIO_SCREEN:
            draw_radio_screen()

        screen.blit(screen_content, (0, 40))
        pygame.display.flip()

        for event in pygame.event.get():
            if event.type == pygame.QUIT:
                pygame.quit()
                sys.exit()
            elif event.type == pygame.KEYDOWN:
                if event.key == pygame.K_TAB and not pygame.key.get_pressed()[pygame.K_LSHIFT] and not pygame.key.get_pressed()[pygame.K_RSHIFT]:
                    current_screen = screens[(screens.index(current_screen) + 1) % len(screens)]
                elif event.key == pygame.K_TAB and (pygame.key.get_pressed()[pygame.K_LSHIFT] or pygame.key.get_pressed()[pygame.K_RSHIFT]):
                    current_screen = screens[(screens.index(current_screen) - 1) % len(screens)]

        clock.tick(30)

if __name__ == "__main__":
    main()
