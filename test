import pygame
import sys
import psutil
import datetime
import subprocess

# Initialize Pygame
pygame.init()

# Screen settings
WIDTH, HEIGHT = 800, 480
BOTTOM_BORDER_HEIGHT = 30
screen = pygame.display.set_mode((WIDTH, HEIGHT))
pygame.display.set_caption("Raspberry Pi Pip-Boy")

# Create a surface for screen content
screen_content = pygame.Surface((WIDTH, HEIGHT - 40 - BOTTOM_BORDER_HEIGHT))

# Colors
GREEN = (57, 255, 20)
BLACK = (0, 0, 0)
ACTIVE_TAB_COLOR = (30, 180, 10)
INACTIVE_TAB_COLOR = BLACK
TEXT_COLOR = GREEN
ACTIVE_TEXT_COLOR = BLACK  # Text color for active tab
BOTTOM_BORDER_COLOR = BLACK

# Fonts
font = pygame.font.Font(None, 36)
small_font = pygame.font.Font(None, 24)

# Screen types (tabs)
STATUS_SCREEN = 0
WIKI_SCREEN = 1
GPS_SCREEN = 2
RADIO_SCREEN = 3

# Start on the STATUS screen
current_screen = STATUS_SCREEN

# Define the tabs
tabs = ["STATUS", "WIKI", "GPS", "RADIO"]

def get_cpu_usage():
    return f"CPU: {psutil.cpu_percent()}%"

def get_storage_space():
    disk = psutil.disk_usage("/")
    return f"Storage Available: {disk.free // (1024**3)} GB"

def get_power_status():
    try:
        battery = psutil.sensors_battery()
        if battery:
            if battery.power_plugged:
                # Approximate power draw calculation (can be improved with specific hardware)
                power_draw = round(psutil.cpu_percent() * 0.1, 2)  # Simulated power draw in Watts
                return f"Power Draw: {power_draw}W"
            else:
                return f"Battery: {battery.percent}%"
        else:
            return "Power: N/A"
    except AttributeError:
        return "Power: N/A"

def get_wifi_signal():
    try:
        result = subprocess.run(["iwconfig", "wlan0"], capture_output=True, text=True)
        if "Signal level=" in result.stdout:
            signal_level = result.stdout.split("Signal level=")[1].split(" ")[0]
            return f"Wi-Fi: {signal_level} dBm"
        else:
            return "Wi-Fi: No Signal"
    except:
        return "Wi-Fi: N/A"

def get_datetime():
    now = datetime.datetime.now()
    return now.strftime("%m-%d-%Y %H:%M:%S")  # MM-DD-YYYY HH:MM:SS format

def draw_text(text, x, y, font_size=36, color=GREEN):
    font = pygame.font.Font(None, font_size)
    rendered_text = font.render(text, True, color)
    screen_content.blit(rendered_text, (x, y))

def draw_tabs():
    tab_width = WIDTH // len(tabs)
    for i, tab in enumerate(tabs):
        tab_rect = pygame.Rect(i * tab_width, 0, tab_width, 40)
        pygame.draw.rect(screen, ACTIVE_TAB_COLOR if i == current_screen else INACTIVE_TAB_COLOR, tab_rect)
        text_color = ACTIVE_TEXT_COLOR if i == current_screen else GREEN
        text_surface = small_font.render(tab, True, text_color)
        text_rect = text_surface.get_rect(center=(i * tab_width + tab_width // 2, 20))
        screen.blit(text_surface, text_rect)

def draw_bottom_border():
    pygame.draw.rect(screen, BOTTOM_BORDER_COLOR, (0, HEIGHT - BOTTOM_BORDER_HEIGHT, WIDTH, BOTTOM_BORDER_HEIGHT))
    datetime_text = small_font.render(get_datetime(), True, GREEN)
    screen.blit(datetime_text, (WIDTH - 180, HEIGHT - BOTTOM_BORDER_HEIGHT + 5))

def draw_status_screen():
    screen_content.fill(BLACK)
    draw_text("SYSTEM STATUS", 280, 60, font_size=48)
    draw_text(get_cpu_usage(), 50, 150, font_size=30)
    draw_text(get_storage_space(), 50, 190, font_size=30)  # Storage space info
    draw_text(get_power_status(), 50, 230, font_size=30)  # Battery % or Power Draw
    draw_text(get_wifi_signal(), 50, 270, font_size=30)

def draw_gps_screen():
    screen_content.fill(BLACK)
    draw_text("GPS: Searching...", 50, 20, font_size=24)
    draw_text("Status: Not Locked", 50, 60, font_size=24)

def draw_wiki_screen():
    screen_content.fill(BLACK)
    draw_text("Offline Wiki: Ready", 50, 20, font_size=24)

def draw_radio_screen():
    screen_content.fill(BLACK)
    draw_text("Radio: Scanning...", 50, 20, font_size=24)

def main():
    global current_screen
    clock = pygame.time.Clock()
    screens = [STATUS_SCREEN, WIKI_SCREEN, GPS_SCREEN, RADIO_SCREEN]
    
    while True:
        screen.fill(BLACK)  
        draw_tabs()

        screen_content.fill(BLACK)  
        if current_screen == STATUS_SCREEN:
            draw_status_screen()
        elif current_screen == WIKI_SCREEN:
            draw_wiki_screen()
        elif current_screen == GPS_SCREEN:
            draw_gps_screen()
        elif current_screen == RADIO_SCREEN:
            draw_radio_screen()

        screen.blit(screen_content, (0, 40))
        draw_bottom_border()  # Draw the bottom border with date & time
        pygame.display.flip()

        for event in pygame.event.get():
            if event.type == pygame.QUIT:
                pygame.quit()
                sys.exit()
            elif event.type == pygame.KEYDOWN:
                if event.key == pygame.K_TAB:
                    shift_pressed = pygame.key.get_pressed()[pygame.K_LSHIFT] or pygame.key.get_pressed()[pygame.K_RSHIFT]
                    if shift_pressed:
                        current_screen = screens[(screens.index(current_screen) - 1) % len(screens)]
                    else:
                        current_screen = screens[(screens.index(current_screen) + 1) % len(screens)]

        clock.tick(30)

if __name__ == "__main__":
    main()
